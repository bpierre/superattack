pico-8 cartridge // http://www.pico-8.com
version 15
__lua__

-- foes format:
--   * sprite index
--   * width (multiple of 8)
--   * name
--   * banner color
-- }
foes={
  {1,4,'owlman',3},
  {5,4,'diabol',4},
  {9,7,'emils',2},
  {64,5,'snek',12},
  {69,4,'globulo',1}
}

-- state vars
p1_press_start=-1
p1_press_stop=-1
p2_press_start=-1
p2_press_stop=-1
p1_foe=1

banner_height=40
turn=1
round_start=-1

function _update60()
  if btnp(0) then
    update_foe(-1)
  end
  if btnp(1) then
    update_foe(1)
  end
  p1_btn(btn(4))
  p2_btn(btn(5))
end

function p1_btn(pressed)
  if pressed then
    if p1_press_start == -1 then
      p1_press_stop=-1
      p1_press_start=t()
    end
  else
    if p1_press_start != -1 then
      p1_press_start=-1
      p1_press_stop=t()
    end
  end
end

function p2_btn(pressed)
  if pressed then
    if p2_press_start == -1 then
      p2_press_stop=-1
      p2_press_start=t()
    end
  else
    if p2_press_start != -1 then
      p2_press_start=-1
      p2_press_stop=t()
    end
  end
end

function restart_round()
  round_start=t()
end

function update_foe(incr)
  local incr_foe = p1_foe + incr
  if incr_foe > 0 and incr_foe <= #foes then
    p1_foe = incr_foe
  end
end

function draw_split(progress, from_right)
  local split_width = 20
  local split_x = -split_width + (127/2 + split_width/2) * progress
  if from_right then
    rectfill(0, 0, split_x, 127, 2)
    for i=0,127 do
      line(
        split_x,
        i,
        (127/2 + split_width/2) * progress,
        0,
        2
      )
    end
  else
    split_x = 127 - split_x
    rectfill(split_x, 0, 127, 127, 4)
    for i=0,127 do
      line(
        split_x,
        127 - i,
        127 - (127/2 + split_width/2) * progress,
        127,
        4
      )
    end
  end
end

function _draw()
  cls()
  local t=t()
  rectfill(0,0,127,127,1)

  local progress_linear=min((t-p1_press_start)*2, 1)
  local progress=ease_out(progress_linear)

  draw_player_foe(p1_press_start, p1_press_stop, p1_foe, true)
  draw_player_foe(p2_press_start, p2_press_stop, p1_foe, false)

  local round_elapsed = flr((t - round_start) / 2)
end

function draw_player_foe(press_start, press_stop, foe, from_right)
  local t=t()
  local progress=0

  if press_start > -1 then
    local progress_linear=max(0, min(1, (t-press_start)*2))
    progress=ease_out(progress_linear)
  end

  if press_stop > -1 then
    local progress_linear=max(1 - ((t-press_stop)*2), 0)
    progress=ease_in(progress_linear)
  end

  draw_split(progress, from_right)

  local w = foe_width(foe)
  local x = 127 - (w + 10) * progress
  local y = 128 - 32

  if from_right then
    x = -w + (w + 10) * progress
    y = 2
  end


  if progress > 0 then
    draw_foe(foe, x, y)
  end

  -- draw_foe_frame(foe, 127/2 - w/2 + 1, 43)

end

function ease_in(t)
  return t * t * t * t * t
end

function ease_out(t)
  t = t - 1
  return 1 + t * t * t * t * t
end

-- the width of a foe in px
function foe_width(foe)
  return 8 * foes[foe][2]
end

function foe_height(foe)
  return 8 * 4
end

function draw_banner(x, bottom, progress, col)
  local height = 27
  if (bottom) then
    local y = 127 - height * progress
    rectfill(0, y, 127, y+3, 5)
    rectfill(0, y+3, 127, y+10, 6)
    rectfill(0, y+10, 127, y+height, col)
  else
    local y = - height + height * progress
    rectfill(0, y, 127, y+height-10, col)
    rectfill(0, y+height-10, 127, y+height-3, 6)
    rectfill(0, y+height-3, 127, y+height, 5)
  end
end

function draw_foe(foe, x, y)
  local w = foe_width(foe)
  local h = foe_height(foe)
  spr(foes[foe][1], x, y, w / 8, h / 8)
end

function draw_foe_frame(foe, x, y)
  local w = foe_width(foe)
  local h = foe_height(foe)
  local padding = 2
  rectfill(x - padding * 2, y, x + w - 1, y + h - 1 + padding * 2, 0)
  rect(x - padding * 2, y, x + w - 1, y + h - 1 + padding * 2, 7)
  draw_foe(foe, x - padding, y + padding)
  rectfill(x - padding * 2, y + h + padding * 2, x + w - 1, y + h + 6 + padding * 2, 0)
  print(foes[foe][3], x + 1 - padding * 2, y + h + 1 + padding * 2, 7)
end

__gfx__
00000000111000000000000000000000000001120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000001211110000000000000000000001112100000000011111111111100000000000000000000000000000000000000d1000000000000000000000000000
007007000124421110000000000000000011221000000011112222222221111011000000000000000000000000000000001d1100000000000000000000000000
00077000001144421110000000000111112442000000015612222122212222115510000000000000000000000000000011dcd100000000000000000000000000
0007700000012444442111111111122444442100000015557122252225222221655100000000000000000000000000011ddcd110000000000000000000000000
007007000000124454444424222454444242210000001555612222222222122156651000000000000000000000000111ddcccd11000000000000000000000000
0000000000001222424444454245444424242100000018566122122222225222117610000000000000000000000011dddccccdd1100000000000000000000000
00000000000012422424444454544442454441000000116611225222222222222111000000000000000000000011dddcccccccd1d11000000000000000000000
000000000000144442221244454442244444210000001211222222212222222222210000000000000000000011dddccccccccccd1d1110000000000000000000
0000000000001244444441242424214544422100000012222222222522222222225100000000000000000011dddcccccccccccccd1ddd1111000000000000000
00000000000011111144441242421244411111000000122222222222222222212211000000000000000011dddccccccccccccccccd1dcddd1110000000000000
000000000000155111111142122124111111510000001222122222222212222522210000000000000111dddccccccccccccccccccccdddcddd11110000000000
0000000000001124218a911525442119a812210000001122522222222222222222210000000000011ddddccccccccccccccccccccccccddcccddddd100000000
00000000000011242225112154541121112421000000152222222221221222222221000000000011ddcccccccccccccccccccccccccccccddccccdddd1100000
0000000000001252422222242151122222444100000012222222221122112222222100000000011ddccccccccccccccccccccccccccccccccd6dccccddd11000
000000000000124224442242454524244442410000001212221122e5225e221122210000000011ddccccccccccccccccccccccccccccccccccccd6ccc7dd1000
000000000000124244224424215142442244410000001252211111522225111112210000000011dcccccccccdcccccccdcccccdccccc65dccccccccccccdd100
00000000000012424424444445115444242241000000122258a7a85222258a7a8521000000011ddcccccccccccdccccccddcddcccc1dccccccccccdccc7cd100
00000000000011242242444451915444424251000000122225555522222255555221000000011dcccccccccccccd11cccccd1ccc11dcccccccccccccccc7d100
00000000000011244244441419a9141442442100000012222252252222225252522110000001dddcccccccccccccd11cccccccc11dcccccccccccccdc7ccdd00
00000000000011244244244597aa944442442100000015222222252222225222522510000001ddcccccccccccccccd1111cccc11a1cccccccccccccccccc7d10
00000000000011222122445191a1915422251100000015222252222222222222222510000001dddccccccccccccccc169111d1196dccccccccccccccccc7cd10
00000000000012542442445128a8215424424100000015252222251222111252222551000001dddcccccccccccccccc1dcc1dcc11ccccccccccccccdc6ccdd10
0000000000001244244244518181815424424100000015252222222222552222522251000001dddccccccccccccccccdccccccccdcccccccccccccccccc7d110
0000000000001244244244511a1a1154244241000000152522111112521111122222510000011dddccccccccccccccccccccccccdcccccccccccccc6ccccd100
0000000000001121421424551aaa15542421410000001525221555111115555112225100000111ddcccccccccccccccdcccccccdccccccccccccccccc7cdd100
00000000000012524424245117a9114442422100000015222115225555525255122251000000111ddcccccccccccc17d7c7dcd7d71ccccccccccccc7cdd11000
0000000000001252442444442191241442424100000055225155222522225225112251000000111ddddcccccccccccdcd72d77dcdcccccccccccc6dddd110000
0000000000001242442445142212545442424100000015525555222552225225512251000000011111dddddccccccccccd8cd2cccccccccccdd6dddd11100000
00000000000012424424444542224444424241000000155222252225222222225522510000000000111111ddddd6d66ccc8cc8cccc6d6ddddddd111000000000
000000000000142424424444454411122441110000015252222222222222522225225110000000000011111111111ddddd2dd2ddddd111111111000000000000
00000000000011115115111151111111111151000001525252222225222222222522551000000000000000000000111111111111111100000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000058a0000008890000888900008a08a0008888a0000000000
000000000000000133333313131313333100000000000000000000022221000000000000000000000889000008958a000508a000089089000890000000000000
00000000000011333bb6b331313133bbb30000000000000000015552255552000000000000000000008900000000890000089000089089000888900000000000
00000000000133333bbbbb3333333bbb633000000000000005667776ff676e25000000000000000000890000000890000089000008888a0005508a0000000000
00000000001333b333bbb6b3b3b3b3bbbb300000000000006777777e777762765200000000000000008a00000089000000089000000089000000890000000000
0000000000333339133bbbbb3b3b3bbbbb33b0000000000577777eff77777f76602220000000000000890000089000000508a0000000890008908a0000000000
000000000333b3917a3bbbbbb3b3b3bbbbb3a0000000001777777f7777776f7766000220000000000888a00008888a000888900000008a000088900000000000
00000000033b33a1a933bbbbbbbbbbbbbbb310000000001777776e6766effe777660000220000000000000000000000000000000000000000000000000000000
0000000033b3b3919a33bbbbbbbb3bbbbbb3a000000001677777e7766ff777777666000002200000000000000000000000000000000000000000000000000000
000000003b3b3b39133b3bbbbbbbbbb3bbb39000000005677777e676e77777777766500000000000000000000000000000000000000000000000000000000000
000000003bb3b3b333b3bbbbbbbbbbbbbbbb3000000012ef7777e666f677777777666000000000000888a00008888a000588900008888a000088a00000000000
000000033bbbbb33333b3bbbbbbbbbbbbbbb30000000177e777688ee2e6777777766610000000000089000000000890008a0890008a0890008908a0000000000
00000003bbbb3bb33b33b3bbbbbbbbbbb6bb30000000177e7768888888867777777661000000000008900000000089000588900008908a0008908a0000000000
000000333bbbbbbb3bbbbbbbbbb6bbbbbbbb30000000177fee888888888e77777776650000000000088895000008900008908900088889000890890000000000
00000033bbbbbbb3bbbbbbbbbbbbbbbbbbbb3000000067777e888511588867777776e52000000000089089000008900008908a00000089000890890000000000
0000003bbbbbbbbbbbbb6bbbbbbbbbbbbbbb33000001677776885122758866f7e676650000000000089089000008a00008a089000500890008a0890000000000
000000333bbb33333bbbbbbbbbbbbbb6bbbbb30000016777768851221582fe76f76fe5200000000008888a000008a0000088850009888a000088900000000000
0000003b3bb33555333bbbbbbbbbbbbbbbbbb3000001677776885111188867777776250200022000000000000000000000000000000000000000000000000000
00000033bb33b3b3b533bbbbbb3bbbbbbb3bb3000001677776888555888e677777766520222002000707070c0707070c0707070c0707070c0707070c00000000
0000033bbbb33b3b3b335bbbbbb31bbbb1bbb300000167777ee8888888e677777776650000000020000000000000000000000000000000000000000000000000
0000033bbbbbb3b3b33533bbbbbb3bbbbbbb3300000157776ffe88888ee677777776610000000000000000000000000000000000000000000000000000000000
000003b3bbbbbbbbbb3bb35bbbbbbbbbbbbb300000001677fe66ffeef66ef7777766510000000000000000000000000000000000000000000000000000000000
0000033bbbbbbbb3bbbbbb33bbbbbbbbbbb3000000001677e6776f76f7fe67777766500000000000000000000000000000000000000000000000000000000000
000003bbbbbbbbbbbbbbbb333bbbbbbbbbb3000000001177f777fe777776e6777765500000000000000000000000000000000000000000000000000000000000
0000033bb3bbbbbbb6bbbbb3533376333670000000000157f677fe7777776e266665000000000000000000000000000000000000000000000000000000000000
000003bbb3bbbbbbbbbbbb3b3b3300088000000000000112ef777e77777776f2f260000000000000000000000000000000000000000000000000000000000000
00003333bbbb6bbbbbbbbbb3b330000880000000000000112e6776e7777777662e50000000000000000000000000000000000000000000000000000000000000
000033b3bbbbbbbbbbbbb3bb3b3000588500000000000001126776ff777776625500000000000000000000000000000000000000000000000000000000000000
00003b3b3b3bbbbbbbbbbbb33330008558000000000000000156776fe66766555020002020000000000000000000000000000000000000000000000000000000
000033b3bbbbbbbbb6bbbbbb3b3000000000000000000000000056662e6500000002220200000000000000000000000000000000000000000000000000000000
00003b33bbbbbbbbbbbbbb3bb3000000000000000000000000000011e00000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000303003e650306501e6502965034650186001d6002860030600276003f6003e600386002f6002c600296002760024600226001e6001c60017600166001560013600126000f6000c6000b6000a6000960008600
0001000033650336500e65033650336501165012650156502b6502b6502b65021650266502d65033650386503e6503e6503e6503d6503c65038650346503065028650216501e65018650116500b6500565001650
0001000036650306502a650266501f6501b6501865015650126500f6500d6500a6500865007650056500465004650056500765008650096500b6500d650156501f650286502a6502d6502f6502f6502d6502b650
000100003c6503a6503965035650326502d650256501c65017650146500000000000000003b650396503665034650326502b6502965025650226501d650116501165000000000000000000000000000000000000
000100002d6502d6502d6502d6502c6500000000000000000000000000000000000000000296502965029650296502965029650000000000000000000000000000000000003b6503b6503b6503b6503b6503b650
000100002a3502735023350213501e3501b3501935016350143501135010350283500e3500c350343500a3502a350093502f35008350093500d35033350173501d350293502f3500000000000000000000000000
000500002e25030250312502a250212501e2501f25022250292502d2502f2502c250212501b250172501525014250142501e2502e2502d2502b250272501e2501a250152500f3500e3500d3500b3500935007350
000700002525020400252501f300252501f3001a2501f30021300274001f35021350243502145025250232002525022200212001d3501e20023150231501e35023150231501620015200142001c3001b3001a300
